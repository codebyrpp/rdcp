import FormView, { FormFieldValuesType, FormValueType } from '@/components/builder/components/FormView';
import Brand from '@/components/common/Brand';
import { useGetFormQuery } from '@/state/apiSlices/formsApi';
import { useEffect } from 'react';
import { useParams } from 'react-router-dom'
import axios from 'axios';
import useSubmitForm from '@/hooks/useSubmitForm';
import Loading from '@/components/common/Loading';

const PageForm = () => {

  const { formId } = useParams<{ formId: string }>()

  // RTK Query hook to get the form settings
  const { data: form, isLoading: isDataLoading, isSuccess } = useGetFormQuery({
    formId: formId ?? '',
    schema: true
  }, {
    skip: !formId
  });

  const { submitForm, loading, error, success } = useSubmitForm();

  useEffect(() => {
    if (success) {
      alert('Form submitted successfully!');
    }
  }, [success]);

  const sendFormDataCallback = async (formId: string, values: FormFieldValuesType): Promise<void> => {
    // Make the POST request
    try {
      await submitForm(formId, values);
      // Handle success, such as showing a message or redirecting
    } catch (err) {
      console.error('Submission error:', err);
    }
  };

  return (
    <div className='overflow-y-hidden min-h-screen flex flex-col justify-between gap-2'>
      {
        isDataLoading && <Loading />
      }
      {
        !isSuccess && <div>Something went wrong</div>
      }
      {
        !form && <div>Form not found</div>
      }
      {
        form && <FormView form={form!} submitFormHandler={sendFormDataCallback} />
      }
      <div className="mt-12">
        <Footer />
      </div>
    </div>
  )
}

// Never submit passwords through Forms generated by Research Data Collector Platform.
// This content is neither created nor endorsed by Research Data Collector Platform.
const Footer = () => {
  return (
    <div className='w-full border-t border-gray-300'>
      <div className='container mx-auto py-4'>
        <div className="transform scale-50">
          <Brand />
        </div>
      </div>
    </div>
  )
}

export default PageForm


